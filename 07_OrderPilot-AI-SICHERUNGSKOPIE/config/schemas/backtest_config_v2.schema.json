{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://orderpilot-ai.local/schemas/backtest_config_v2.schema.json",
  "title": "Backtesting Configuration V2",
  "description": "Einheitliches Schema fuer Backtesting-Konfigurationen mit Optimierungsparametern, Strategie-Profilen und erweiterten Features",
  "type": "object",
  "required": ["version", "meta", "strategy_profile"],
  "additionalProperties": false,

  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema Reference"
    },

    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema-Version im SemVer-Format",
      "default": "2.0.0"
    },

    "extends": {
      "type": "string",
      "description": "Pfad zu einem Basis-Template, das erweitert wird"
    },

    "meta": {
      "$ref": "#/definitions/MetaSection"
    },

    "strategy_profile": {
      "$ref": "#/definitions/StrategyProfileSection"
    },

    "entry_score": {
      "$ref": "#/definitions/EntryScoreSection"
    },

    "entry_triggers": {
      "$ref": "#/definitions/EntryTriggersSection"
    },

    "exit_management": {
      "$ref": "#/definitions/ExitManagementSection"
    },

    "risk_leverage": {
      "$ref": "#/definitions/RiskLeverageSection"
    },

    "execution_simulation": {
      "$ref": "#/definitions/ExecutionSimulationSection"
    },

    "optimization": {
      "$ref": "#/definitions/OptimizationSection"
    },

    "walk_forward": {
      "$ref": "#/definitions/WalkForwardSection"
    },

    "parameter_groups": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ParameterGroup"
      },
      "description": "Parameter-Gruppen die zusammen getestet werden"
    },

    "conditionals": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Conditional"
      },
      "description": "Bedingte Parameter-Anpassungen"
    },

    "constraints": {
      "$ref": "#/definitions/ConstraintsSection"
    },

    "overrides": {
      "type": "object",
      "description": "Parameter-Overrides fuer extends-Modus",
      "additionalProperties": true
    }
  },

  "definitions": {
    "OptimizableFloat": {
      "type": "object",
      "required": ["value"],
      "properties": {
        "value": { "type": "number" },
        "optimize": { "type": "boolean", "default": false },
        "range": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 2
        },
        "min": { "type": "number" },
        "max": { "type": "number" },
        "step": { "type": "number" }
      }
    },

    "OptimizableInt": {
      "type": "object",
      "required": ["value"],
      "properties": {
        "value": { "type": "integer" },
        "optimize": { "type": "boolean", "default": false },
        "range": {
          "type": "array",
          "items": { "type": "integer" },
          "minItems": 2
        },
        "min": { "type": "integer" },
        "max": { "type": "integer" },
        "step": { "type": "integer" }
      }
    },

    "MetaSection": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name der Konfiguration"
        },
        "description": {
          "type": "string",
          "description": "Beschreibung des Szenarios"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Erstellungsdatum im ISO-8601-Format"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "author": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Tags fuer Kategorisierung"
        },
        "target_asset_class": {
          "type": "string",
          "enum": ["crypto", "stocks", "forex", "futures"],
          "default": "crypto"
        },
        "target_timeframe": {
          "type": "string",
          "enum": ["1m", "5m", "15m", "30m", "1h", "4h", "1d"],
          "default": "5m"
        },
        "scenario_type": {
          "type": "string",
          "enum": ["conservative", "aggressive", "balanced"],
          "default": "balanced"
        }
      }
    },

    "StrategyProfileSection": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["trendfollowing", "mean_reversion", "breakout", "scalping", "hybrid"],
          "description": "Strategie-Typ"
        },
        "preset": {
          "type": "string",
          "enum": ["W0", "W1", "W2", "custom"],
          "default": "W0",
          "description": "Weight-Preset fuer Entry Score"
        },
        "direction_bias": {
          "type": "string",
          "enum": ["BOTH", "LONG_ONLY", "SHORT_ONLY"],
          "default": "BOTH"
        }
      }
    },

    "EntryScoreSection": {
      "type": "object",
      "properties": {
        "weights": {
          "type": "object",
          "properties": {
            "use_preset": {
              "type": ["string", "null"],
              "enum": ["W0", "W1", "W2", null]
            },
            "custom": {
              "type": ["object", "null"],
              "properties": {
                "trend_alignment": { "$ref": "#/definitions/OptimizableFloat" },
                "momentum_rsi": { "$ref": "#/definitions/OptimizableFloat" },
                "momentum_macd": { "$ref": "#/definitions/OptimizableFloat" },
                "trend_strength": { "$ref": "#/definitions/OptimizableFloat" },
                "volatility": { "$ref": "#/definitions/OptimizableFloat" },
                "volume": { "$ref": "#/definitions/OptimizableFloat" }
              }
            }
          }
        },
        "weight_presets": {
          "type": "object",
          "description": "Vordefinierte Weight-Kombinationen",
          "properties": {
            "W0": { "$ref": "#/definitions/WeightPreset" },
            "W1": { "$ref": "#/definitions/WeightPreset" },
            "W2": { "$ref": "#/definitions/WeightPreset" }
          }
        },
        "thresholds": {
          "type": "object",
          "properties": {
            "min_score_for_entry": { "$ref": "#/definitions/OptimizableFloat" },
            "excellent": { "type": "number", "default": 0.80 },
            "good": { "type": "number", "default": 0.65 },
            "moderate": { "type": "number", "default": 0.50 },
            "weak": { "type": "number", "default": 0.35 }
          }
        },
        "gates": {
          "type": "object",
          "properties": {
            "block_in_chop": { "type": "boolean", "default": true },
            "block_against_strong_trend": { "type": "boolean", "default": true },
            "allow_counter_trend_sfp": { "type": "boolean", "default": false }
          }
        },
        "indicator_params": {
          "type": "object",
          "properties": {
            "ema_short": { "type": "integer", "default": 20 },
            "ema_medium": { "type": "integer", "default": 50 },
            "ema_long": { "type": "integer", "default": 200 },
            "rsi_period": { "type": "integer", "default": 14 },
            "rsi_overbought": { "type": "integer", "default": 70 },
            "rsi_oversold": { "type": "integer", "default": 30 },
            "adx_period": { "type": "integer", "default": 14 },
            "adx_strong_trend": { "type": "number", "default": 25.0 },
            "adx_weak_trend": { "type": "number", "default": 15.0 },
            "atr_period": { "type": "integer", "default": 14 }
          }
        },
        "regime_modifiers": {
          "type": "object",
          "properties": {
            "boost_strong_trend": { "type": "number", "default": 0.10 },
            "penalty_chop": { "type": "number", "default": -0.15 },
            "penalty_volatile": { "type": "number", "default": -0.10 }
          }
        }
      }
    },

    "WeightPreset": {
      "type": "object",
      "required": ["trend", "rsi", "macd", "adx", "vol", "volume"],
      "properties": {
        "trend": { "type": "number", "minimum": 0, "maximum": 1 },
        "rsi": { "type": "number", "minimum": 0, "maximum": 1 },
        "macd": { "type": "number", "minimum": 0, "maximum": 1 },
        "adx": { "type": "number", "minimum": 0, "maximum": 1 },
        "vol": { "type": "number", "minimum": 0, "maximum": 1 },
        "volume": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "EntryTriggersSection": {
      "type": "object",
      "properties": {
        "breakout": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "volume_multiplier": { "$ref": "#/definitions/OptimizableFloat" },
            "close_threshold": { "$ref": "#/definitions/OptimizableFloat" },
            "confirmation_candles": { "type": "integer", "default": 1 }
          }
        },
        "pullback": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "max_distance_atr": { "$ref": "#/definitions/OptimizableFloat" },
            "min_strength": { "type": "number", "default": 0.3 },
            "patience_candles": { "type": "integer", "default": 5 },
            "rejection_wick_pct": { "$ref": "#/definitions/OptimizableFloat" }
          }
        },
        "sfp": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "wick_body_ratio": { "$ref": "#/definitions/OptimizableFloat" },
            "penetration_pct": { "$ref": "#/definitions/OptimizableFloat" },
            "quick_reversal_candles": { "type": "integer", "default": 2 }
          }
        }
      }
    },

    "ExitManagementSection": {
      "type": "object",
      "properties": {
        "stop_loss": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["atr_based", "percent_based", "structure_based"],
              "default": "atr_based"
            },
            "atr_multiplier": { "$ref": "#/definitions/OptimizableFloat" },
            "percent": { "$ref": "#/definitions/OptimizableFloat" },
            "structure_buffer_atr": { "type": "number", "default": 0.2 }
          }
        },
        "take_profit": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["atr_based", "percent_based", "rr_ratio", "level_based"],
              "default": "atr_based"
            },
            "atr_multiplier": { "$ref": "#/definitions/OptimizableFloat" },
            "percent": { "$ref": "#/definitions/OptimizableFloat" },
            "rr_ratio": { "$ref": "#/definitions/OptimizableFloat" },
            "use_level": { "type": "boolean", "default": false }
          }
        },
        "trailing_stop": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "type": {
              "type": "string",
              "enum": ["atr_based", "percent_based"],
              "default": "atr_based"
            },
            "move_to_breakeven": { "type": "boolean", "default": true },
            "activation_atr": { "$ref": "#/definitions/OptimizableFloat" },
            "activation_percent": { "$ref": "#/definitions/OptimizableFloat" },
            "distance_atr": { "$ref": "#/definitions/OptimizableFloat" },
            "distance_percent": { "$ref": "#/definitions/OptimizableFloat" },
            "step_percent": { "$ref": "#/definitions/OptimizableFloat" }
          }
        },
        "partial_tp": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "tp1_percent": { "type": "number", "default": 50 },
            "tp1_rr": { "type": "number", "default": 1.0 },
            "move_sl_to_be": { "type": "boolean", "default": true }
          }
        },
        "time_stop": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "max_holding_minutes": { "type": "integer", "default": 480 }
          }
        }
      }
    },

    "RiskLeverageSection": {
      "type": "object",
      "properties": {
        "risk_per_trade_pct": { "$ref": "#/definitions/OptimizableFloat" },
        "base_leverage": { "$ref": "#/definitions/OptimizableInt" },
        "max_leverage": { "type": "integer", "default": 20 },
        "min_liquidation_distance_pct": { "type": "number", "default": 5.0 },
        "max_daily_loss_pct": { "type": "number", "default": 3.0 },
        "max_trades_per_day": { "type": "integer", "default": 10 },
        "max_concurrent_positions": { "type": "integer", "default": 1 },
        "max_loss_streak": { "type": "integer", "default": 3 },
        "cooldown_after_streak_min": { "type": "integer", "default": 60 }
      }
    },

    "ExecutionSimulationSection": {
      "type": "object",
      "properties": {
        "initial_capital": { "type": "number", "default": 10000 },
        "symbol": { "type": "string" },
        "base_timeframe": { "type": "string", "default": "1m" },
        "mtf_timeframes": {
          "type": "array",
          "items": { "type": "string" },
          "default": ["5m", "15m", "1h", "4h", "1D"]
        },
        "fee_maker_pct": { "type": "number", "default": 0.02 },
        "fee_taker_pct": { "type": "number", "default": 0.06 },
        "assume_taker": { "type": "boolean", "default": true },
        "slippage_method": {
          "type": "string",
          "enum": ["fixed_bps", "atr_based", "volume_adjusted"],
          "default": "fixed_bps"
        },
        "slippage_bps": { "type": "number", "default": 5.0 },
        "slippage_atr_mult": { "type": "number", "default": 0.1 },
        "funding_rate_8h": { "type": "number", "default": 0.01 }
      }
    },

    "OptimizationSection": {
      "type": "object",
      "properties": {
        "method": {
          "type": "string",
          "enum": ["grid", "random", "bayesian"],
          "default": "random"
        },
        "max_iterations": { "type": "integer", "default": 300 },
        "n_jobs": { "type": "integer", "default": 1 },
        "seed": { "type": "integer", "default": 42 },
        "target_metric": {
          "type": "string",
          "enum": ["expectancy", "profit_factor", "sharpe", "sortino", "calmar", "max_dd"],
          "default": "expectancy"
        },
        "minimize": { "type": "boolean", "default": false },
        "early_stopping": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "patience": { "type": "integer", "default": 50 },
            "min_improvement": { "type": "number", "default": 0.01 }
          }
        },
        "parameter_space_override": {
          "type": "object",
          "additionalProperties": {
            "type": "array"
          }
        }
      }
    },

    "WalkForwardSection": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean", "default": false },
        "train_window_days": { "type": "integer", "default": 90 },
        "test_window_days": { "type": "integer", "default": 30 },
        "step_size_days": { "type": "integer", "default": 30 },
        "min_folds": { "type": "integer", "default": 4 },
        "reoptimize_each_fold": { "type": "boolean", "default": true }
      }
    },

    "ParameterGroup": {
      "type": "object",
      "required": ["name", "parameters", "combinations"],
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "parameters": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 2,
          "description": "JSON-Pfade zu den Parametern"
        },
        "combinations": {
          "type": "array",
          "items": {
            "type": "array",
            "items": { "type": "number" }
          },
          "description": "Liste von Werte-Kombinationen"
        }
      }
    },

    "Conditional": {
      "type": "object",
      "required": ["if", "then"],
      "properties": {
        "if": {
          "type": "object",
          "description": "Bedingung als JSON-Pfad zu Wert oder Vergleichsobjekt"
        },
        "then": {
          "type": "object",
          "description": "Anzuwendende Parameter-Aenderungen"
        }
      }
    },

    "ConstraintsSection": {
      "type": "object",
      "properties": {
        "min_trades": { "type": "integer", "default": 50 },
        "max_drawdown_pct": { "type": "number", "default": 30 },
        "min_win_rate": { "type": "number", "default": 0.40 },
        "min_profit_factor": { "type": "number", "default": 1.2 },
        "min_sharpe": { "type": "number" },
        "min_sortino": { "type": "number" },
        "max_consecutive_losses": { "type": "integer" },
        "weights_must_sum_to_one": { "type": "boolean", "default": true }
      }
    }
  }
}
