<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Chart - OrderPilot-AI</title>

    <!-- Lightweight Charts Library from CDN -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Qt WebChannel Library -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #131722;
            color: #d1d4dc;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #chart-container {
            flex: 1;
            position: relative;
            background: #131722;
        }

        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            z-index: 1000;
        }

        #status h2 {
            color: #2962ff;
            margin-bottom: 10px;
        }

        #status.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #2962ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error-message {
            color: #f23645;
            margin-top: 20px;
            padding: 10px;
            background: rgba(242, 54, 69, 0.1);
            border-radius: 4px;
            display: none;
        }

        #error-message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="chart-container">
            <div id="status">
                <h2>Initializing Chart...</h2>
                <div class="spinner"></div>
                <p>Connecting to Python backend...</p>
            </div>
        </div>
        <div id="error-message"></div>
    </div>

    <script>
        // Global variables
        let chart = null;
        let candlestickSeries = null;
        let equitySeries = null;
        let indicatorSeries = {};
        let chartBridge = null;

        // Initialize Qt WebChannel
        new QWebChannel(qt.webChannelTransport, function(channel) {
            chartBridge = channel.objects.chartBridge;
            console.log("WebChannel connected successfully");

            // Connect to signals
            chartBridge.chartDataReady.connect(onChartDataReady);
            chartBridge.error.connect(onError);
            chartBridge.statusChanged.connect(onStatusChanged);

            // Update status
            updateStatus("Ready", "Waiting for backtest data...");
        });

        // Create Lightweight Charts instance
        function createChart() {
            const container = document.getElementById('chart-container');

            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { type: 'solid', color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2B2B43',
                },
                timeScale: {
                    borderColor: '#2B2B43',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // Handle resize
            window.addEventListener('resize', () => {
                if (chart) {
                    chart.resize(container.clientWidth, container.clientHeight);
                }
            });

            console.log("Lightweight Charts initialized");
        }

        // Handle chart data from Python
        function onChartDataReady(jsonData) {
            console.log("Received chart data:", jsonData.length, "bytes");

            try {
                const data = JSON.parse(jsonData);
                console.log("Parsed chart data:", data);

                // Check if it's a trade update or full data
                if (data.type === 'trade_update') {
                    updateTradeMarkers(data.markers);
                    return;
                }

                // Clear existing chart
                clearChart();

                // Create chart if not exists
                if (!chart) {
                    createChart();
                }

                // Render full chart
                renderChart(data);

                // Hide status message
                hideStatus();

            } catch (error) {
                console.error("Error processing chart data:", error);
                showError("Failed to render chart: " + error.message);
            }
        }

        // Render complete chart
        function renderChart(data) {
            // 1. Candlestick series
            if (data.candlesticks && data.candlesticks.length > 0) {
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });
                candlestickSeries.setData(data.candlesticks);
                console.log("Loaded", data.candlesticks.length, "candlesticks");
            }

            // 2. Equity curve (on separate pane)
            if (data.equity_curve && data.equity_curve.length > 0) {
                equitySeries = chart.addLineSeries({
                    color: '#2962ff',
                    lineWidth: 2,
                    priceScaleId: 'equity',
                    title: 'Equity'
                });
                chart.priceScale('equity').applyOptions({
                    scaleMargins: {
                        top: 0.7,
                        bottom: 0,
                    },
                });
                equitySeries.setData(data.equity_curve);
                console.log("Loaded", data.equity_curve.length, "equity points");
            }

            // 3. Indicators
            if (data.indicators) {
                const colors = ['#f7931a', '#9c27b0', '#00bcd4', '#4caf50', '#ff9800'];
                let colorIndex = 0;

                for (const [name, series_data] of Object.entries(data.indicators)) {
                    const indicatorSeries = chart.addLineSeries({
                        color: colors[colorIndex % colors.length],
                        lineWidth: 1,
                        title: name,
                        lastValueVisible: false,
                        priceLineVisible: false
                    });
                    indicatorSeries.setData(series_data);
                    indicatorSeries[name] = indicatorSeries;
                    colorIndex++;
                    console.log("Loaded indicator:", name, "with", series_data.length, "points");
                }
            }

            // 4. Trade markers
            if (data.markers && data.markers.length > 0 && candlestickSeries) {
                candlestickSeries.setMarkers(data.markers);
                console.log("Loaded", data.markers.length, "trade markers");
            }

            // 5. Fit content
            chart.timeScale().fitContent();

            console.log("Chart rendered successfully");
        }

        // Update trade markers (for live updates)
        function updateTradeMarkers(markers) {
            if (candlestickSeries && markers && markers.length > 0) {
                // Get existing markers
                const existingMarkers = candlestickSeries.markers() || [];

                // Merge with new markers
                const allMarkers = [...existingMarkers, ...markers];

                // Sort by time
                allMarkers.sort((a, b) => a.time - b.time);

                candlestickSeries.setMarkers(allMarkers);
                console.log("Updated markers, total:", allMarkers.length);
            }
        }

        // Clear all chart series
        function clearChart() {
            if (!chart) return;

            // Remove all series
            if (candlestickSeries) {
                chart.removeSeries(candlestickSeries);
                candlestickSeries = null;
            }

            if (equitySeries) {
                chart.removeSeries(equitySeries);
                equitySeries = null;
            }

            for (const series of Object.values(indicatorSeries)) {
                chart.removeSeries(series);
            }
            indicatorSeries = {};

            console.log("Chart cleared");
        }

        // Handle errors from Python
        function onError(errorMsg) {
            console.error("Python error:", errorMsg);
            showError(errorMsg);
        }

        // Handle status updates from Python
        function onStatusChanged(statusMsg) {
            console.log("Status:", statusMsg);
        }

        // UI helper functions
        function updateStatus(title, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <h2>${title}</h2>
                <div class="spinner"></div>
                <p>${message}</p>
            `;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = "Error: " + message;
            errorDiv.classList.add('visible');

            // Hide after 5 seconds
            setTimeout(() => {
                errorDiv.classList.remove('visible');
            }, 5000);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            console.log("Page loaded, waiting for WebChannel...");
        });
    </script>
</body>
</html>
