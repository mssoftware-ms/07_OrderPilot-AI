# JSON Format Specification v2.1

**Version:** 2.1.0
**Last Updated:** 2026-02-08

---

## Overview

This document defines the v2.1 JSON format for Strategy Settings Pipeline.

**Three types:**
1. `strategy_config` - Complete strategy with indicators and entry/exit rules
2. `indicator_set` - Reusable indicator collections
3. `regime_optimization_results` - Backtested regime configurations

---

## Universal Requirements

All v2.1 JSONs MUST have:

```json
{
  "kind": "strategy_config|indicator_set|regime_optimization_results",
  "schema_version": "2.1.0"
}
```

**Validation:** Fail-closed. Invalid JSON is rejected immediately.

---

## 1. strategy_config

### Schema
[`schemas/strategy_config.schema.json`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/schemas/strategy_config.schema.json)

### Structure

```json
{
  "kind": "strategy_config",
  "schema_version": "2.1.0",
  "strategies": [
    {
      "name": "Trend Following Long",
      "description": "Follows strong uptrends",
      "entry": {
        "all": [...],  // All conditions must be true
        "any": [...]   // At least one must be true
      },
      "entry_expression": "trend == 'UP' && rsi < 70",  // CEL expression (optional)
      "exit": {
        "all": [...],
        "any": [...]
      }
    }
  ],
  "indicators": [
    {
      "name": "EMA_20",
      "type": "EMA",
      "params": {"period": 20}
    }
  ],
  "regimes": [
    {
      "id": "TREND_UP",
      "conditions": {...}
    }
  ]
}
```

### Key Points

- **`entry_expression`** (CEL): Preferred method. If missing, uses `entry` conditions.
- **Fail-Closed:** Missing expression → Entry disabled, score penalty.
- **Indicators:** Must be used in entry/exit logic.

---

## 2. indicator_set

### Schema
[`schemas/indicator_set.schema.json`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/schemas/indicator_set.schema.json)

### Structure

```json
{
  "kind": "indicator_set",
  "schema_version": "2.1.0",
  "name": "Trend Indicators",
  "description": "EMAs and MACD for trend following",
  "indicators": [
    {
      "name": "EMA_50",
      "type": "EMA",
      "params": {"period": 50}
    },
    {
      "name": "MACD",
      "type": "MACD",
      "params": {
        "fast": 12,
        "slow": 26,
        "signal": 9
      }
    }
  ]
}
```

### Usage

Indicator sets can be referenced in `strategy_config` to avoid duplication.

---

## 3. regime_optimization_results

### Schema
[`schemas/regime_optimization_results.schema.json`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/schemas/regime_optimization_results.schema.json)

### Structure

```json
{
  "kind": "regime_optimization_results",
  "schema_version": "2.1.0",
  "regimes": [
    {
      "id": "TREND_UP_NORMAL",
      "conditions": {...},
      "backtest_score": 0.75,
      "sample_size": 1000
    }
  ],
  "optimization_metadata": {
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "algorithm": "genetic",
    "generations": 50
  }
}
```

### Constraints

- **No mixing:** `optimization_results` MUST NOT appear in `strategy_config` or `indicator_set`.
- **Read-only:** Generated by backtester, not hand-edited.

---

## Common Components

### Indicators

```json
{
  "name": "RSI_14",          // Unique name
  "type": "RSI",             // Indicator type
  "params": {                // Type-specific params
    "period": 14
  }
}
```

**Supported types:** EMA, SMA, RSI, MACD, BB, ATR, ADX, Stochastic, etc.

### Regimes

```json
{
  "id": "TREND_UP",          // Unique ID
  "conditions": {
    "all": [
      {
        "indicator": "EMA_20",
        "operator": ">",
        "value": "EMA_50"
      }
    ]
  }
}
```

**Operators:** `>`, `<`, `>=`, `<=`, `==`, `!=`, `crosses_above`, `crosses_below`

### CEL Expressions

**Context variables:**
- `trend`: "UP" | "DOWN" | "SIDEWAYS"
- `volume`: "HIGH" | "LOW" | "NORMAL"
- `volatility`: "HIGH" | "LOW" | "NORMAL"
- All indicator values by name (e.g., `ema_20`, `rsi_14`)

**Example:**
```
trend == 'UP' && rsi < 70 && ema_20 > ema_50
```

---

## Migration from v1

Use migration tool:
```bash
python migrations/migrate_v1_to_v2.py --dir 03_JSON/Trading_Bot --dry-run
```

**Changes:**
- ✅ Adds `kind`
- ✅ Adds `schema_version`
- ✅ Standardizes indicator format
- ✅ Validates output

---

## Validation

All JSONs are validated against schemas at load time.

**Error handling:**
- Schema violation → Rejected (Fail-Closed)
- Missing `kind` → Legacy Shim auto-detects (with warning)
- Invalid CEL → Entry disabled, logged

**Check validity:**
```python
from src.core.tradingbot.config.kind_loader import KindConfigLoader

loader = KindConfigLoader()
config = loader.load(Path("strategy.json"))  # Raises ValidationError if invalid
```

---

## References

- Schemas: [`schemas/`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/schemas/)
- Pipeline: [`strategy_settings_pipeline.py`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/src/core/tradingbot/strategy_settings_pipeline.py)
- CEL Docs: [`docs/CEL_Regime_Entry_Pipeline.md`](file:///d:/03_Git/02_Python/07_OrderPilot-AI/docs/CEL_Regime_Entry_Pipeline.md)
